= Member Operator

image:https://goreportcard.com/badge/github.com/codeready-toolchain/member-operator[Go Report Card, link="https://goreportcard.com/report/github.com/codeready-toolchain/member-operator"]
image:https://godoc.org/github.com/codeready-toolchain/member-operator?status.png[GoDoc,link="https://godoc.org/github.com/codeready-toolchain/member-operator"]
image:https://codecov.io/gh/codeready-toolchain/member-operator/branch/master/graph/badge.svg[Codecov.io,link="https://codecov.io/gh/codeready-toolchain/member-operator"]

This is the CodeReady Toolchain Member Operator repository. It contains the OpenShift Operator that is deployed on the "member" cluster in the SaaS.

== Build

This repository uses https://github.com/golang/go/wiki/Modules[Go modules]. You may need to `export GO111MODULE=on` to turn modules support "on".

== Development

To run this operator locally you need to have at least one Minishift profile started:

```bash
$ minishift start --profile member
```

Then you can run the operator locally with the help of `operator-sdk` (you need version v0.10.0 or higher):

```bash
$ make up-local
```

That Makefile target takes care of additional several steps which can be executed separately:

* logging as system:admin user: `$ make login-as-admin`
* creating local test namespace: `$ make create-namespace`
* deploy CRDs: `$ make deploy-crd`
* building the project: `$ make build`
* deploying ClusterRole/ClusterRoleBinding and creating ServiceAccount: `$ make deploy-rbac`

There are a few more targets that you can find useful:

* to login as system:admin user and enter the local test namespace: `$ make use-namespace`
* to remove the local test namespace: `$ make clean-namespace`
* to remove & create the local test namespace, and create ClusterRole/ClusterRoleBinding and ServiceAccount inside of the namespace: `$ make reset-namespace`

=== End-to-End tests

==== Background & pairing

E2E tests are not located in this repository - all e2e tests are in the https://github.com/codeready-toolchain/toolchain-e2e[toolchain-e2e] repo, however, it's still possible to run them locally from this repo - see <<Running End-to-End Tests>>.

When there is a change introduced in this repository that should be either covered by e2e tests or requires changes in the already existing tests, then all needed changes should go into the https://github.com/codeready-toolchain/toolchain-e2e[toolchain-e2e] repo.
The logic that executes tests in openshift-ci automatically tries to pair any PR opened for this (member-operator) repository with a branch that potentially exists in the developer's fork of the https://github.com/codeready-toolchain/toolchain-e2e[toolchain-e2e] repo. This pairing is based on the current branch name.

For example, if a developer with a GH account `cooljohn` opens a PR (for member-operator repo) from a branch `fix-reconcile`, then the logic checks if there is a branch named `fix-reconcile` also in the `cooljohn/toolchain-e2e` fork.
If there is a match, then the logic:

1. clones the latest changes from https://github.com/codeready-toolchain/toolchain-e2e[codeready-toolchain/toolchain-e2e]
2. fetches the `fix-reconcile` branch from `cooljohn/toolchain-e2e` fork
3. merges the `master` branch with the changes from `fix-reconcile` branch
4. clones the latest changes from https://github.com/codeready-toolchain/host-operator[host-operator] repo, then builds and deploys the `host-operator` image out of it
5. builds & deploys the `member-operator` image from the code that is in the PR
6. runs the e2e tests against both operators from the merged branch of the `toolchain-e2e` repo

If the branch with the same name does not exist, then it only clones the latest changes from https://github.com/codeready-toolchain/toolchain-e2e[toolchain-e2e] and runs e2e tests from the `master`.

If you still don't know what to do with e2e tests in some use-cases, go to <<What to do>> section where all use-cases are covered.

==== Prerequisites if running locally on minishift
If you are running this tests locally on minishift, make sure that you have exposed minishift's docker-env, so that deployment can use locally built image. You can expose it by running following command.
`eval $(minishift docker-env)`

NOTE: This is not required for openshift-ci environment

==== Running End-to-End Tests

Although the e2e tests are in the separated repository, it's still possible to run them from this repo (member-operator) and also against the current code that is the local repository (directory).
There are two Makefile targets that will execute the e2e tests:

* `make test-e2e` - this target clones latest changes from https://github.com/codeready-toolchain/toolchain-e2e[toolchain-e2e] and runs e2e tests for both operators from the master. As deployment for `member-operator` it uses the current code that is in the local repository.
* `make test-e2e-local` - this target doesn't clone anything, but it runs run e2e tests for both operators from the directory `../toolchain-e2e`. As deployment for `member-operator` it uses the current code that is in the local repository.

The tests executed within https://github.com/codeready-toolchain/toolchain-e2e[toolchain-e2e] repo will take care of creating all needed namespaces with random names (or see below for enforcing some specific namespace names).
It will also create all required CRDs, role and role bindings for the service accounts, build the Docker images for both operators and push them to the OpenShift container registry. Finally, it will deploy the operators and run the tests using the operator-sdk.

 NOTE: you can override the default namespace names where the end-to-end tests are going to be executed - eg.: `make test-e2e HOST_NS=my-host MEMBER_NS=my-member` file.

===== What to do

If you are still confused by the e2e location, execution and branch pairing, see the following cases and needed steps:

* *Working locally:*
** *Need to test your code using the latest version of e2e tests from https://github.com/codeready-toolchain/toolchain-e2e[toolchain-e2e] repo:*
*** execute `make test-e2e`
** *Need to test your code using e2e tests located in `../toolchain-e2e` repo:*
*** execute `make test-e2e-local`

* *Creating a PR:*
** *Your PR doesn't need any changes in https://github.com/codeready-toolchain/toolchain-e2e[toolchain-e2e] repo:*
*** check the name of a branch you are going to create a PR for
*** make sure that your fork of https://github.com/codeready-toolchain/toolchain-e2e[toolchain-e2e] repo doesn't contain branch with the same name
*** create a PR
** *Your PR requires changes in https://github.com/codeready-toolchain/toolchain-e2e[toolchain-e2e] repo:*
*** check the name of a branch you are going to create a PR for
*** create a branch with the same name within your fork of https://github.com/codeready-toolchain/toolchain-e2e[toolchain-e2e] repo and put all necessary changes there
*** push all changes into both forks of the repositories https://github.com/codeready-toolchain/toolchain-e2e[toolchain-e2e] and https://github.com/codeready-toolchain/member-operator[member-operator]
*** create a PR for https://github.com/codeready-toolchain/member-operator[member-operator]
*** create a PR for https://github.com/codeready-toolchain/toolchain-e2e[toolchain-e2e]

=== Verifying the OpenShift CI configuration

It's possible to verify the OpenShift CI config from the developer's laptop while all the jobs are executed on the remote, online CI platform:

1. checkout and build the https://github.com/openshift/ci-tools[CI Operator] command line tool
2. login to https://console.svc.ci.openshift.org (via GH OAuth) and copy the login command (you may need to switch to the `application console`)
3. login with the command aferementioned
4. run the CI jobs with 
+
```
ci-operator --config ../../openshift/release/ci-operator/config/codeready-toolchain/member-operator/codeready-toolchain-member-operator-master.yaml --git-ref=codeready-toolchain/member-operator@master
``` 
+
assuming that the https://github.com/openshift/release[OpenShift Release] repo was checked you.

NOTE: you can ignore the RBAC issues that are displayed in the console

NOTE: prepare some üçøor ‚òïÔ∏è, the whole build can take more than 10 minutes...

=== Adding clusters to SaaS

The CodeReady Toolchain architecture contains two types of clusters `host` and `member`.
To connect these two clusters together it is necessary to run a script link:https://raw.githubusercontent.com/codeready-toolchain/toolchain-common/master/scripts/add-cluster.sh[add-cluster.sh] that is part of the link:https://github.com/codeready-toolchain/toolchain-common[toolchain-common] repository.
For more detailed information about the script see the link:https://github.com/codeready-toolchain/toolchain-common#add-clustersh[README "Script add-cluster.sh" chapter].

There are two Makefile targets available in this repository that execute the script:

*  `$ make add-member-to-host` that executes `../toolchain-common/scripts/add-cluster.sh member member-cluster`
*  `$ make add-host-to-member` that executes `../toolchain-common/scripts/add-cluster.sh host host-cluster`

NOTE: In order to run them, you need to have the link:https://github.com/codeready-toolchain/toolchain-common[toolchain-common] repository cloned to the same parent directory as this repository exists in.
